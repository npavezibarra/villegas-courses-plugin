REPORT 1: YOUR SCORE

This report details the data pipeline and rendering process for the "Tu puntaje" (Your Score) section of the First Quiz email template.

A. How the score is obtained

1.  **PHP Function for Data Retrieval:** The primary data originates from the `$quiz_data` array passed to the `villegas_get_first_quiz_email_content` function in `emails/first-quiz-email.php`. The specific score is expected in the `percentage` key (i.e., `$quiz_data['percentage']`).
2.  **Data Sanitization:** The raw value is processed by `villegas_normalize_percentage_value( $quiz_data['percentage'] ?? null )`. This helper function, located in `includes/emails.php`, ensures the value is a standard float. It handles various input formats, such as strings containing commas or periods, by filtering non-numeric characters and performing string replacement.
3.  **Variable Storage:** The sanitized percentage is stored in the `$current_percentage` variable. This value is then assigned to `$user_score`, which is clamped to a range of 0.0 to 100.0 using `max( 0.0, min( 100.0, $user_score ) )` to prevent invalid values from breaking the chart generation.
4.  **Percentage Calculation:** The percentage is expected to be pre-calculated by the LearnDash system before being passed to the email handler. The email template logic itself does not perform the (correct / total * 100) calculation; it trusts the incoming `$quiz_data['percentage']` value.

B. How the QuickChart URL is built

1.  **PHP Function for URL Generation:** The doughnut chart image URL is generated by the `villegas_generate_quickchart_url` function, found in `includes/emails.php`.
2.  **URL Construction:** The function constructs a URL for the QuickChart.io service. The base URL is `https://quickchart.io/chart?c=`.
3.  **Chart Configuration:** A PHP array (`$config`) is built to define the chart's properties. This array includes:
    *   `type`: 'doughnut'
    *   `data.datasets[0].data`: An array containing two values: the user's score (`$chart_value`) and the remainder to 100 (`$remaining`).
    *   `data.datasets[0].backgroundColor`: An array of colors: `'#f9c600'` for the score and `'#f2f2f2'` for the remainder.
    *   `data.datasets[0].borderWidth`: `0`
    *   `data.datasets[0].cutout`: `'70%'`
    *   `data.datasets[0].rotation`: `270` (starts the chart from the top).
4.  **Value Insertion:** The `$user_score` variable is passed to this function. It's rounded to two decimal places and stored as `$chart_value`.
5.  **Label Configuration:** The large percentage label in the center of the chart is configured under `options.plugins.doughnutlabel`. The label's text is set to `sprintf( '%d%%', $label_value_int )`, where `$label_value_int` is a rounded integer version of the user's score. The font size is 34, bold, and colored `#222222`.
6.  **Final URL:** The `$config` array is encoded into a JSON string using `wp_json_encode()`, then URL-encoded via `urlencode()`. This final string is appended to the base URL. The result is stored in the `$user_chart_url` variable.

C. How HTML displays the chart

1.  **HTML Tag:** The chart is rendered in the email body using a standard HTML `<img>` tag.
2.  **Layout:** The image is placed within a `<table>` structure for email client compatibility. The main container table is `#villegas-email-graficas`. The "Tu puntaje" chart is in the first `<td>` of a nested table.
3.  **Titles:** A heading `<h2>Tu puntaje</h2>` is placed directly above the chart image.
4.  **Wrapper Classes:** There are no specific CSS classes applied to the wrapper elements; layout is controlled by table IDs and inline styles.

D. CSS behavior

1.  **Media Queries:** An inline `<style>` block contains a media query: `@media only screen and (max-width: 500px)`. This applies styles for mobile clients.
2.  **Layout Stacking:** For screens narrower than 500px, the CSS rule `#villegas-email-graficas td` changes the table cells to `display: block !important;` and `width: 90% !important;`. This breaks the side-by-side layout and stacks the two chart sections vertically.
3.  **Centering and Spacing:** The same rule applies `margin: 0 auto !important;` and `text-align: center !important;` to center the stacked charts. A separate rule for `#villegas-email-graficas h2` adds a `margin-top: 24px !important;` to create space between the first title and the edge of the card when stacked.

---

REPORT 2: PROMEDIO VILLEGAS

This report analyzes the pipeline for generating the "Promedio Villegas" (Villegas Average) data and chart.

A. How the average is obtained

1.  **PHP Function for Data Retrieval:** The global average score is computed by the static method `Villegas_Quiz_Stats::get_average_percentage( $stats_quiz_id )`. This class is defined in `classes/class-villegas-quiz-stats.php`.
2.  **Database Query:** This function calls another method, `self::get_all_attempts_for_quiz( $quiz_id )`, which executes a direct SQL query against the WordPress database. It joins the `{$wpdb->prefix}learndash_user_activity` and `{$wpdb->prefix}learndash_user_activity_meta` tables to retrieve all recorded attempts for a specific quiz ID.
3.  **Student Contribution:** Every user attempt with a valid, non-null `percentage` value contributes to the average. The number of contributing students is the count of these valid attempts.
4.  **Calculation:** The `get_average_percentage` method plucks the 'percentage' values from the query results, filters out any nulls, and then calculates the average using `array_sum( $valid_percentages ) / count( $valid_percentages )`.
5.  **Variable Storage:** The calculated average is returned and stored in the `$average_score` variable in `first-quiz-email.php`. This value is then sanitized and clamped between 0.0 and 100.0, with the final result stored in `$average_value`.

B. How the second QuickChart URL is generated

1.  **Function:** The same `villegas_generate_quickchart_url` function is used to generate the URL for the average score chart.
2.  **Dynamic Value:** The `$average_value` variable is passed as the first argument to the function.
3.  **Chart Configuration:** The QuickChart configuration is identical to the user score chart. It uses the same doughnut type, colors, cutout, rotation, and label styling. The only difference is the numerical data (`[ $chart_value, $remaining ]`) being encoded into the URL.
4.  **Variable:** The generated URL is stored in the `$average_chart_url` variable.

C. HTML placement

1.  **Wrapper Element:** The "Promedio Villegas" chart is outputted in the second `<td>` element, immediately following the `<td>` for the user score chart, within the same `<tr>`.
2.  **Class Names:** No specific class names are used. The layout is managed by the parent table with the ID `villegas-email-graficas`.
3.  **Right-Hand Chart:** Because it is the second cell in the table row, it naturally appears as the right-hand chart in desktop email clients that render tables side-by-side.

D. CSS and stacking

1.  **CSS Classes:** The CSS rules are the same as those for the first chart, as they target the `<td>` element within `#villegas-email-graficas`.
2.  **Mobile Collapse:** On screens narrower than 500px, the `@media` query's `display: block !important;` rule applies to this chart's `<td>` as well, causing it to stack vertically below the "Tu puntaje" chart.

---

REPORT 3: CTA SECTION

This report details the structure and data sources for the Call-to-Action (CTA) block at the bottom of the email.

A. Where CTA data comes from

1.  **Static vs. Dynamic:** The section contains both static text and dynamic data. The main paragraph ("Cada lección completada...") is a static string translated using WordPress's localization functions (`esc_html__()`).
2.  **Dynamic URLs:** The primary dynamic element is the button. Its URL and text are determined by conditional logic in `first-quiz-email.php`.
3.  **Course Link Variable:** The base course link is retrieved using the WordPress function `get_permalink( $course_id )` and stored in the `$course_url` variable.
4.  **Conditional Logic:** The logic checks two conditions:
    *   If the course is free (`$is_free_course`).
    *   If the user has access to the course (`$has_access`), determined by the custom function `Villegas_Course::user_has_access()`.
5.  **Button States:**
    *   **Access Granted:** If the user has access or the course is free, the `$button_label` is "Ir al curso" (Go to course) and the `$button_url` is the direct course permalink. The `$button_note` explains that the user should continue with the lessons.
    *   **Access Denied (Paid Course):** If the user does not have access to a paid course, the button becomes a purchase link. The `$button_label` changes to "Comprar curso" (Buy course). The `$button_url` is generated to add the related WooCommerce product to the cart, using functions like `Villegas_Course::get_related_product_id()` and `wc_get_checkout_url()`. The `$button_note` prompts the user to buy the course.

B. HTML structure

1.  **Container:** The entire CTA block is enclosed in a `<td>` with `id="villegas-email-cta"`.
2.  **Elements:** The structure is simple:
    *   A `<p>` tag for the main descriptive text.
    *   An `<a>` tag for the button.
    *   A final `<p>` tag for the note below the button.
3.  **Styling:** All styling is applied inline using the `style` attribute on each element, which is a common practice for HTML emails to ensure maximum client compatibility. The button, for example, has inline styles for `display`, `background`, `color`, `padding`, `border-radius`, and `text-decoration`.

C. CSS behavior

1.  **Control:** All stylistic aspects—padding, spacing, fonts, and alignment—are controlled by inline CSS properties on the HTML tags. The container `<td>` has `padding: 32px 48px;` and `text-align: center;`.
2.  **Font and Color:** The paragraphs have their `font-size` and `color` set inline. The button's text color and background color are also set inline.
3.  **Mobile Adjustments:** There are no specific media queries that target this CTA section. Its layout is inherently responsive due to the centered text and block-level button (`display: inline-block` within a centered parent). It appears consistent across desktop and mobile views.

D. Function references

1.  **WordPress Functions:**
    *   `get_permalink()`: Retrieves the URL for the course post.
    *   `add_query_arg()`: Adds the `add-to-cart` parameter to the checkout URL.
    *   `esc_html__()`, `esc_html()`: For translation and secure output of text.
    *   `esc_url()`: For securing URL output.
2.  **LearnDash Functions:**
    *   `learndash_get_setting()`: Used to check the `course_price_type` of the course.
3.  **WooCommerce Functions:**
    *   `wc_get_checkout_url()`: Used when creating the purchase link.
4.  **Plugin Utility Functions:**
    *   `Villegas_Course::user_has_access()`: Checks if the user is enrolled in the course.
    *   `Villegas_Course::get_related_product_id()`: Finds the WooCommerce product associated with the LearnDash course.
    *   No global utility injects styles into this specific section; all styles are self-contained within the `villegas_get_first_quiz_email_content` function's body string.